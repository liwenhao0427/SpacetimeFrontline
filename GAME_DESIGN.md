# 游戏设计文档: 超时空防线 (v3.1)

## 1. 项目概述

**核心概念:** 
一款深度融合了**网格布局塔防** (Grid-based Tower Defense), **自走棋战术** (Auto-Battler tactics), 以及**Roguelite成长体系**的策略游戏。其核心玩法深受《植物大战僵尸》的单位布局和《土豆兄弟》(Brotato) 的道具叠加系统启发。玩家在一个5x9的网格上战略性地部署和升级各种基于Emoji或卡通精灵的单位，以抵御一波又一波日益强大的敌人。

**核心体验:**
*   **战略深度:** 单位的放置、它们之间的协同作用，以及永久性道具带来的数值叠加，共同构成了一个复杂且引人入胜的决策空间。
*   **双轨制成长系统:**
    1.  **战内升级 (战术层面):** 在战斗中通过击杀敌人获得经验值以升级。升级时暂停游戏，从三个随机的临时增益选项中进行“三选一”抉择，这些增益仅在当前波次生效。
    2.  **商店成长 (战略层面):** 在波次间的商店里购买能够永久提升全局属性的道具、购买新的永久性单位，或购买经验值为英雄进行永久性的“进化”。
*   **动态的战斗节奏:** 游戏采用了一种富有节奏的敌人生成系统。大部分敌人在每5秒和10秒的节点上以规模递增的“脉冲”形式大举进攻，同时伴有持续的零星骚扰，创造出张弛有度的战斗节奏。
*   **视觉风格:** 采用现代化、整洁的卡通风格，UI面板使用玻璃拟态（Glassmorphism）效果，并搭配生动的Emoji或定制的2D精灵角色。

**技术栈:**
*   **前端:** React, Tailwind CSS
*   **核心引擎:** HTML5 Canvas (`services/engine/`)
*   **状态管理:** Zustand
*   **交互:** 鼠标驱动的单位拖拽布局与实体悬停/点击检视。

---

## 2. 核心游戏循环

游戏围绕一个引人入胜且可重复的循环构建：

1.  **开始阶段 (START)**
    *   游戏从一个精致的开始界面启动。
    *   点击“开始防御”进入下一阶段。

2.  **游戏设置阶段 (SETUP)**
    *   弹出一个模态框，允许玩家选择英雄、配置单位和道具的随机池，以及选择波次配置（如标准战役或Boss Rush）。
    *   确认配置后，游戏状态被初始化。

3.  **商店 & 准备阶段 (SHOP)**
    *   游戏在新一局开始时或每波战斗结束后进入此阶段。
    *   一个全屏的商店模态框出现，提供一系列可供购买的永久性道具和新单位。
    *   玩家可以购买经验值来提升**英雄等级**。英雄每次升级，都会弹出一个**英雄进化模态框**，让玩家从三个随机的**永久强化**选项中选择一个，用于构建英雄的独特能力。
    *   在此阶段，玩家可以自由地通过拖拽来重新布置网格上的单位，或通过右键出售单位。
    *   当准备就绪后，玩家点击“返回战场”隐藏商店，再点击“开始战斗”以进入新的战斗阶段。

4.  **战斗阶段 (COMBAT)**
    *   敌人从屏幕右侧，按照预设的、富有节奏的脉冲式波次生成。
    *   我方单位会根据其攻击逻辑自动索敌并发起攻击。
    *   **动态升级:** 击杀敌人会获得经验值。当经验条满时，玩家升级，战斗将**立即暂停**，并弹出一个**战场支援模态框**，提供三个随机的、仅限本波次生效的临时增益选项。
    *   选择一个增益后，其效果被应用，战斗继续。
    *   当波次计时器归零时，战斗结束，所有幸存的敌人都将被清除。
    *   如果有任何敌人突破了最左侧的防线，游戏结束。

5.  **游戏结束 (GAME OVER)**
    *   当有敌人越过位于 `x = GRID_OFFSET_X` 的防线时触发。
    *   屏幕上会显示玩家最终抵达的波数，并提供一个“重新挑战”的选项，该选项会将玩家带回设置阶段。

---

## 3. 战场与单位系统

### 3.1 战场网格
*   **尺寸:** 一个 5 行 9 列的网格。
*   **放置:** 每个格子只能放置一个单位。
*   **交互:** 在商店阶段，可以通过拖拽单位来交换它们的位置或移动到空格。在战斗阶段，单位位置被锁定。右键点击单位可以将其出售并获得部分金币返还。

### 3.2 单位
单位是玩家造成伤害和控制战场的主要工具。

*   **通用属性:**
    | 属性 | 描述 |
    | :--- | :--- |
    | **id, name, emoji** | 唯一标识符、显示名称和视觉形象。 |
    | **description / desc** | 在检视面板中显示的说明文本和战术信息。 |
    | **type** | `MELEE`, `RANGED`, `MAGIC`, `ENGINEERING`。决定了单位能享受哪种类型的扁平伤害加成。 |
    | **baseDamage, maxCooldown** | 基础伤害值和攻击间隔（秒）。 |
    | **range** | 攻击范围（以“格”为单位）。 |
    | **hp / maxHp**| 单位的生命值。降至零时，`isDead` 变为 true。 |
    | **isDead** | 阵亡的单位在本波次中将无法行动，显示为墓碑 (🪦) 或死亡动画。 |
    | **isTemp** | 若为 true (来自升级选项)，该单位会在战斗阶段结束后被移除。 |
    | **row, col** | 单位在网格上的位置。 |
    | **attackPattern**| 定义单位的攻击方式，如 `SHOOT` (射击), `THRUST` (突刺), `STREAM` (持续喷射), `NONE` (不攻击)。 |
    | **effects** | 一个对象，用于存储单位的特殊效果，如 `generate_gold`, `explode_on_death` 等。 |
    | **spriteConfig** | (可选) 定义了单位使用2D精灵图时的动画配置。 |

*   **单位生命与复活:**
    *   在战斗中阵亡的**非临时**单位，会在下一波的商店阶段开始时以满血状态复活。
    *   临时单位（雇佣兵）在阵亡或波次结束后将被永久移除。

*   **英雄单位 ("键盘侠")**
    *   玩家独一无二的核心单位，无法被出售或替换。初始攻击力较低，但成长潜力巨大。
    *   拥有一个随时间自动增长的**能量条**。当能量条充满时，会自动释放**终极技能**，在短时间内极大地提升自身**攻击速度**。
    *   英雄拥有独立的、可通过商店购买经验值提升的**永久等级**。每次升级，玩家都可以在多个强化路径中三选一，以获得永久性的强大能力。这些路径充满权衡：
        *   **多重射击:** 从双发到三向，再到五向齐射。每次升级都会显著**降低英雄20%的伤害**，考验玩家构筑多段伤害协同的能力。
        *   **射击特效:** 为子弹附加追踪、爆炸、连锁反应等效果，提供功能性。
        *   **弹射:** 增加子弹的弹射次数。每次升级都会**降低英雄10%的攻击速度**，是用频率换取覆盖范围。
        *   **终极技能强化:** 一条专门强化大招的路径，可提升大招攻速、伤害、持续时间，甚至赋予击杀延长效果。
        *   **基础属性:** 无限叠加地提升伤害 (+50%) 或攻击速度 (+30%)，是稳定提升的选择。

---

## 4. 战斗系统

### 4.1 索敌与攻击逻辑
*   **标准索敌 (MELEE, RANGED, ENGINEERING):** 优先攻击**同一行**内距离最近的敌人。
*   **全局索敌 (MAGIC / 特殊效果):** 优先攻击攻击范围内距离最近的敌人，**无视行限制**。当单位拥有追踪效果或极大射程时也会触发。
*   **英雄索敌:** 根据其当前的 `attackType` 行为：
    *   `LINEAR`: 沿其所在行直线射击。
    *   `TRACKING`: 发射追踪弹攻击最近的敌人。
    *   `DOUBLE_SHOT`: 在y轴上轻微偏移发射两枚子弹。
    *   `TRI_SHOT`: 同时向自己所在行、及上下相邻行发射弹射物。
    *   `PENTA_SHOT`: 同时向所有五行发射弹射物。

### 4.2 伤害与冷却计算
最终的战斗属性由单位的基础值和玩家通过道具与升级获得的全局属性组合而成。所有百分比增益都以**乘法**叠加，形成独立的“乘区”。详细公式请参阅 `docs/NUMERICAL_DESIGN.md`。

### 4.3 敌人系统
*   **生成机制 (脉冲式):**
    *   每波开始时，系统会根据 `waves.ts` 的配置和玩家的 `enemy_count` 属性，预先生成该波次的所有敌人队列。
    *   系统以**5秒**和**10秒**为周期，将大部分敌人（主爆发70%，次爆发20%）以递增的比例分配到这些时间节点上，形成“脉冲式”的敌袭。
    *   剩余的少量敌人则会在整个波次持续时间内被**平滑、均匀地**投放，形成持续的骚扰。
*   **行为:**
    1.  从屏幕右侧外的一个随机行生成，并通过算法避免在同一位置堆叠。
    2.  沿直线向左移动。
    3.  当进入我方单位的攻击范围时，停止移动并发起攻击。
    4.  攻击动作通过一个快速的“前冲”动画来可视化。

---

## 5. 成长与经济系统

### 5.1 战内升级 (临时)
*   **经验获取:** 击杀敌人会掉落经验值（以浮动文字形式显示）。
*   **升级:** 玩家有一个独立的等级和经验条。当经验条满时，游戏暂停，弹出“战场支援”模态框。
*   **升级选项:** 模态框提供三个随机、互斥的临时增益选项：
    1.  **雇佣兵 (临时单位):** 在一个空格子上增加一个强大的临时单位。
    2.  **英雄增益:** 临时强化英雄单位（例如，提升能量相关属性）。
    3.  **全局增益:** 临时影响所有单位（例如，“本波次所有单位伤害 +10%”）。
    4.  **英雄升级(临时):** 提供一个临时的英雄进化选项，效果同永久升级，但仅限本波次。

### 5.2 商店成长 (永久)
*   **金币:** 主要货币，通过击杀敌人和`收获(Harvesting)`属性获得。
*   **商店界面:** 一个在波次间隙出现的全屏界面，随机展示4个可供购买的商品。
*   **商品类型:**
    1.  **单位:** 购买后可将一个新的永久性单位放置到战场的一个空格子上。
    2.  **道具 (Brotato-style):** 购买后为玩家提供永久性的被动属性加成 (`PlayerStats`)。这是跨波次提升实力的主要方式。
*   **商店机制:**
    *   **刷新:** 支付递增数量的金币来刷新商店的商品列表。
    *   **锁定:** 点击锁定按钮可以保留某个商品，使其在刷新时不会被替换掉。
*   **英雄进化 (永久升级):**
    *   玩家可以在商店中花费金币购买经验值，以提升**英雄等级**。
    *   英雄等级独立于战内等级，是永久性的。
    *   每次英雄升级，都会触发一个特殊的**英雄进化模态框**，提供三个永久性的英雄技能强化选项，让玩家能够定制化地构建英雄的成长路径。

---

## 6. UI / UX

*   **HUD (平视显示器):** 顶部一个简洁的HUD条，显示等级/经验、金币、当前波数和波次计时器。右侧有一个可展开的菜单，详细列出所有从道具中获得的激活属性加成。
*   **检视面板 (Inspector):** 一个位于屏幕左侧或右侧（取决于检视对象位置）的、情境感知的面板。
    *   **悬停:** 实时显示任何单位或敌人的最终计算属性。
    *   **点击锁定:** 点击一个实体可将其详细信息固定在面板上，以便持续观察。
    *   **属性分解:** 在伤害、冷却等属性上悬停时，会显示其完整的计算公式 (`(基础 + 扁平加成) * 百分比乘数`)。
*   **库存面板 (Inventory):** 在商店阶段，左下角会显示玩家当前拥有的所有“Brotato-style”道具图标。
*   **视觉反馈:**
    *   **受击闪烁:** 实体在受到伤害时会短暂闪烁白色或红色。
    *   **浮动文字:** 伤害数值、经验和金币获取会以浮动文字的形式出现。
    *   **选中指示器:** 一个虚线构成的、旋转的圆圈会出现在被检视的实体周围。
    *   **英雄终极技能:** 屏幕上出现巨大的 "OVERDRIVE!" 文字，英雄身上伴有强烈的视觉特效。
*   **开发者工具 (Supermarket):** 在商店中提供一个隐藏入口，可以免费获取游戏内的任何单位或道具，用于快速测试和调试。